# Progress — 2026-02-17

## Work Done: Protocol Setup Validation

Added machine config loading, bounds validation, and protocol setup orchestration to ensure protocols are safe to run before execution.

### New Modules

**`src/machine/`** — Machine config loading
- `yaml_schema.py`: Pydantic schemas (`MachineYamlSchema`, `WorkingVolumeYaml`, `CncYaml`) with strict validation (extra="forbid", min < max for all axes, homing strategy literal)
- `machine_config.py`: `MachineConfig` and `WorkingVolume` frozen dataclasses. `WorkingVolume.contains(x, y, z)` checks inclusive bounds.
- `loader.py`: `load_machine_from_yaml()` + `load_machine_from_yaml_safe()` with user-friendly error messages
- `errors.py`: `MachineLoaderError`

**`src/validation/`** — Bounds validation
- `bounds.py`: `validate_deck_positions(machine, deck)` checks every labware position (all wells, all vial locations) against machine bounds. `validate_gantry_positions(machine, deck, board)` checks computed gantry positions for every (instrument, position) combination using formula `gantry_pos = deck_pos - instrument_offset`.
- `errors.py`: `BoundsViolation` dataclass and `SetupValidationError` exception (collects all violations before raising)

**`src/protocol_engine/setup.py`** — Protocol setup orchestrator
- `setup_protocol(machine_path, deck_path, board_path, protocol_path, gantry=None)` loads all four configs, runs both validation passes, returns `(Protocol, ProtocolContext)` ready to run
- Uses mock gantry by default for offline validation

### Modified Files
- `src/protocol_engine/protocol.py`: Added optional `machine: MachineConfig | None = None` field to `ProtocolContext` (backward-compatible)
- `README.md`: Added machine config, validation, setup sections; updated config paths
- `AGENTS.md`: Added machine, validation, setup sections; updated config paths; added config directory structure
- `configs/decks/deck.sample.yaml`: Updated path reference in comment
- `configs/protocols/protocol.sample.yaml`: Updated path reference in comment

### Config Reorganization
Moved all config files from flat `configs/` into typed subdirectories:
- `configs/machines/` — machine YAML (genmitsu_3018_PRO_Desktop.yaml, genmitsu_3018_PROver_v2.yaml)
- `configs/decks/` — deck YAML (deck.sample.yaml, mofcat_deck.yaml)
- `configs/boards/` — board YAML (mofcat_board.yaml)
- `configs/protocols/` — protocol YAML (protocol.sample.yaml)

### Test Files Created
- `tests/machine/test_yaml_schema.py` — 19 tests (schema field validation, bounds ordering, extra key rejection)
- `tests/machine/test_machine_config.py` — 14 tests (WorkingVolume.contains, boundary edge cases, frozen dataclass)
- `tests/machine/test_machine_loader.py` — 15 tests (happy path, missing file, invalid YAML, safe wrapper)
- `tests/validation/test_bounds_validation.py` — 24 tests (deck bounds, gantry bounds, edge cases, error detail)
- `tests/setup/test_protocol_setup.py` — 12 tests (full setup, missing files, bounds violations, mock gantry)
- `tests/setup/test_integration.py` — 5 tests (end-to-end with all 4 YAML configs, protocol execution)

### Test Results
- New tests: 89
- Existing tests: 329 (all passing, no regressions)
- Total: 418 tests passing

### Key Design Decisions
- Validation returns `list[BoundsViolation]` (not fail-fast) so all issues are reported at once
- Inclusive boundaries: position exactly on x_min or x_max is valid
- Gantry position formula replicated from `Board.move()` for offline validation
- `ProtocolContext.machine` is optional for backward compatibility
- Config files organized by type for clarity
