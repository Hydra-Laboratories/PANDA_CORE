# Progress: 2026-02-17 — SQLite Data Persistence Layer

## Summary
Implemented a complete SQLite data persistence layer for PANDA_CORE. All state (labware volumes, well contents, measurements) lives in the database — Python labware objects are stateless to survive interrupts/crashes. An empty initialized database template is shipped at `data/databases/panda_data.db`.

## Work Completed

### DataStore Core (`data/data_store.py`)
- SQLite-backed `DataStore` class with 6 tables: `campaigns`, `experiments`, `uvvis_measurements`, `filmetrics_measurements`, `camera_measurements`, `labware`
- Foreign key enforcement via `PRAGMA foreign_keys = ON`
- BLOB serialization for UV-Vis spectra using `struct.pack('<Nd', ...)` — lossless round-trip for float64 arrays
- `log_measurement()` dispatches by `isinstance()` (UVVisSpectrum, MeasurementResult, or str)
- Context manager support
- **20 tests** in `tests/data/test_data_store.py`

### Labware Table (DB-persisted state)
- `labware` table tracks per-well/per-vial: `total_volume_ul`, `working_volume_ul`, `current_volume_ul`, `contents` (JSON)
- `register_labware(campaign_id, key, labware)` — creates 1 row per vial, 1 row per well for plates
- `record_dispense(campaign_id, key, well_id, source, volume)` — atomically increments volume and appends to contents JSON
- `get_contents(campaign_id, key, well_id)` — returns parsed contents list
- Duplicate registration check raises `ValueError`
- **15 tests** in `tests/data/test_labware_table.py`

### ProtocolContext Integration
- Added `data_store: Any = None` and `campaign_id: int | None = None` to `ProtocolContext`
- Both default to `None` — fully backward compatible
- **3 tests** in `tests/protocol_engine/test_protocol_context_data_store.py`

### Protocol Command Wiring
- **Bug fix in scan**: `callable_method(plate_obj)` → `callable_method()` — instruments take no args
- **Return type fix in scan**: `Dict[str, bool]` → `Dict[str, Any]`
- **Return type fixes in pipette**: `aspirate`, `dispense`, `mix` return `Any`
- **DB-based tracking**: `dispense` and `transfer` call `data_store.record_dispense()` when a DataStore is present
- **Scan logging**: snapshots contents from DB via `get_contents()`, creates experiment + measurement rows
- **Helper `_parse_position()`**: Splits `"plate_1.A1"` → `("plate_1", "A1")`
- **Fixed scan test**: `_FakeSensor.measure()` signature updated (removed plate arg)
- **7 tests** in `tests/data/test_command_logging.py`

### Documentation & Integration
- Updated `AGENTS.md` with Data Persistence section (DB-only state model)
- Updated `README.md` with usage example including `register_labware()`
- Empty `.db` template at `data/databases/panda_data.db`
- **2 integration tests** in `tests/data/test_integration.py`

## Key Design Decision: Stateless Python Objects
Initially implemented in-memory content tracking on `Vial.contents` and `WellPlate.contents`/`add_content()`. **Reverted** — Python objects are ephemeral and lose state on interrupt (power loss, unplug, crash). All state now lives in SQLite, which survives restarts. Labware models remain pure geometry/config.

## Issues Found and Resolved

1. **Scan command bug**: `callable_method(plate_obj)` was passing the plate to `measure()`, but all instruments' `measure()` methods take zero arguments.

2. **SQLite NULL uniqueness**: `UNIQUE(campaign_id, labware_key, well_id)` doesn't prevent duplicate NULLs in SQLite. Added explicit `COUNT(*)` check in `register_labware()` before inserting.

## PR Review Fixes (Session 2)

Ran comprehensive 4-agent PR review (code-reviewer, test-coverage-analyzer, silent-failure-hunter, comment-analyzer). Applied the following fixes:

### 1. `register_labware()` type guard (`data/data_store.py`)
- Added `isinstance(labware, Labware)` check at the top — raises `TypeError` for non-Labware inputs
- Added `else` clause after WellPlate/Vial branches for unsupported Labware subtypes
- Updated docstring with `Raises` section

### 2. Removed `dispense` as a YAML protocol command (`src/protocol_engine/commands/pipette.py`)
- Removed `@protocol_command("dispense")` decorator — `dispense()` is now a private helper, not exposed to user YAML
- Removed buggy DB logging from standalone `dispense()` (was using destination as source_name)
- Users should use `transfer` instead, which correctly tracks source labware
- Removed `test_dispense_records_to_labware_table` test (was testing the buggy behavior)

### 3. Error handling around DB logging
- Wrapped scan DB logging block in `try/except` with `logger.exception()` (`scan.py`)
- Wrapped `_record_dispense_to_store` body in `try/except` with `logger.exception()` (`pipette.py`)
- DB failures now log errors instead of crashing the experiment mid-run

### 4. Fixed `_parse_position()` return type (`pipette.py`)
- Changed bare `tuple` → `tuple[str, Optional[str]]`
- Added 4 unit tests in `TestParsePosition` class

### 5. Fixed `setup.cfg` package discovery conflict
- Removed `[options.packages.find]` section from `setup.cfg` — `pyproject.toml` is the single source of truth

### 6. Documentation fixes
- Updated `scan` docstring with DataStore side-effect note
- Fixed AGENTS.md: softened "atomically increments" to "increments" in `record_dispense` description
- Fixed AGENTS.md: removed `dispense` from auto-persist command list (only `scan` and `transfer` now)

## Test Count
- **Total: 396 tests, all passing**
- Session 1 new tests: 47 (20 + 15 + 3 + 7 + 2)
- Session 2: +4 (parse_position) −1 (removed dispense DB test) = net +3
- No regressions in existing test suite

## Files

### New files
| File | Purpose |
|------|---------|
| `data/__init__.py` | Package init, exports DataStore |
| `data/data_store.py` | SQLite DataStore class |
| `data/databases/panda_data.db` | Empty initialized database template |
| `tests/data/__init__.py` | Test package init |
| `tests/data/test_data_store.py` | DataStore CRUD + measurement tests |
| `tests/data/test_labware_table.py` | Labware table register/dispense/get tests |
| `tests/data/test_command_logging.py` | Command-level DB logging tests |
| `tests/data/test_integration.py` | End-to-end integration tests |
| `tests/protocol_engine/test_protocol_context_data_store.py` | ProtocolContext + DataStore tests |

### Modified files
| File | Change |
|------|--------|
| `src/protocol_engine/protocol.py` | Added `data_store`, `campaign_id` to ProtocolContext |
| `src/protocol_engine/commands/scan.py` | Fixed method call bug, fixed return type, added DB logging |
| `src/protocol_engine/commands/pipette.py` | Fixed return types, added DB-based dispense tracking |
| `tests/protocol_engine/test_scan_command.py` | Fixed `_FakeSensor.measure()` signature |
| `AGENTS.md` | Documented data persistence layer |
| `README.md` | Added data persistence usage example |
| `.gitignore` | Added SQLite journal file exclusions |
| `pyproject.toml` | Added project root to package discovery |
| `setup.cfg` | Updated package discovery |
