# 2026-02-11: CNC Hardware Verification & Safety Refactor

## Summary
Successfully verified connection and movement on the Genmitsu 3018 PROver v2.
Encountered and resolved multiple issues related to the legacy driver's restrictive safety logic, which was built for a different machine/coordinate assumption.

## Key Changes

### 1. Connection & Configuration
- **Port Detection**: Prioritized auto-scanning by default. Removed hardcoded `/dev/cu.usbserial-130`.
- **Feed Rate**: Added default feed rate (`2000 mm/min`) on connection to prevent `error:22` (Undefined Feed Rate) during initial moves.
- **Config Fixing**: Fixed Pydantic validation errors by making `machine_bounds` and `safe_z_height` optional in `DeckConfig`.

### 2. Coordinate System Cleanup (The "Safety Removal" Refactor)
To enable the machine to move according to the user's actual coordinate system (which includes positive Z), we stripped out several "opinionated" legacy features from `src/instrument_drivers/cnc_driver/driver.py`:

- **Removed Artificial Offset**: The driver was adding `+2.0` mm to all reported `MPos` coordinates (likely to compensate for a specific homing pull-off). This caused validation errors because the driver also strictly enforced `Coordinate <= 0`.
- **Disabled Coordinate Validation**: Commented out `_validate_target_coordinates`. The driver now accepts ANY coordinate (positive or negative) and relies on the G-code/Machine to handle limits.
- **Disabled Z-Clamping**: `_calculate_target_coordinates` no longer forces Z to be `min(target, 0.0)`. It now passes the requested Z through.
- **Disabled "Safe Move" Logic**: `safe_move` no longer automatically lifts Z to `0.0` before moving horizontally. It now executes a direct move.

## Verified Functionality
- `hardware_verification/cnc/check_connection.py`: Connects, reads status/coordinates correctly (Raw MPos).
- `hardware_verification/cnc/test_move_left.py`: Calculates target and executes move. Verified physical movement.

## Future Work / Re-implementation Plan
The safety features were removed because they were blocking legitimate operation. They should be re-implemented correctly:

1.  **Soft Limits**: Rely on GRBL internal soft limits (`$20=1`) instead of Python-side checks where possible.
2.  **Coordinate Systems**: If Python needs to validate coordinates, it must be aware of the *actual* machine workspace (Work Offsets `G54` or Machine Limits `$130`).
3.  **Safe Z**: Re-implement "Safe Z" logic as a configurable strategy (e.g., "Retract by 5mm" vs "Go to Absolute 0"), rather than a hardcoded "Go to 0.0".
