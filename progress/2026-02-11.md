# 2026-02-11: CNC Hardware Verification & Safety Refactor

## Summary
Successfully verified connection and movement on the Genmitsu 3018 PROver v2.
Encountered and resolved multiple issues related to the legacy driver's restrictive safety logic, which was built for a different machine/coordinate assumption.

## Findings
- `driver.py` uses `serial` logic with `G-Code` commands.
- Safety includes soft limits checks, alarm state handling, and a `safe_move` method.
- Current `Mill` class lacks `BaseInstrument` inheritance and standard `health_check` methods proposed in `architecture.md`.

## Filmetrics Instrument Port to PANDA_CORE

### Work Done
1. **Restructured `base_instrument.py`**: Moved from `src/core/` to `src/instruments/`, deleted empty `src/core/`, created `src/instruments/__init__.py` exporting `BaseInstrument` and `InstrumentError`. Updated import in `tests/test_base_instrument.py`.
2. **Created `src/instruments/filmetrics/` package** with:
   - `models.py` — `MeasurementResult` frozen dataclass with `is_valid` property (GOF >= 0.6 threshold)
   - `exceptions.py` — `FilmetricsError` hierarchy: `FilmetricsConnectionError`, `FilmetricsCommandError`, `FilmetricsParseError` (all subclass `InstrumentError`)
   - `driver.py` — `Filmetrics(BaseInstrument)` driver that launches `FilmetricsTool.exe` as subprocess and communicates via stdin/stdout text commands. Methods: `connect()`, `disconnect()`, `health_check()`, `acquire_sample()`, `acquire_reference()`, `acquire_background()`, `commit_baseline()`, `measure()`, `save_spectrum()`
   - `mock.py` — `MockFilmetrics(BaseInstrument)` with in-memory behavior, `command_history` tracking, configurable default `MeasurementResult`
   - `reference/FilmetricsTool_program.cs` — Copy of C# source for protocol reference
3. **Tests**: 40 new tests in `tests/test_filmetrics.py` covering models, exceptions, parsing, lifecycle, commands, mock. All 45 tests (5 original + 40 new) pass.
4. **Updated docs**: AGENTS.md and README.md with Filmetrics instrument documentation.

### Design Decisions
- `disconnect()` writes "exit\n" directly to stdin rather than using `_send_command()`, since the C# app prints "Exiting..." (not a completion sentinel) and then exits
- Parsing logic uses same regexes as the original Python script for Polyimide thickness and GOF extraction
- `save_spectrum()` is a placeholder — data saving will be a cross-instrument process later
- Completion sentinels: lines containing "complete" or "successfully" (case-insensitive), matching C# app output patterns
